# Heap Functions Security Checks

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## unlink

This function removes a chunk from a doubly linked list. Common checks ensure that the linked list structure remains consistent when unlinking chunks.

* **Consistency Checks**:
  * Check if `P->fd->bk == P` and `P->bk->fd == P`.
    * Error message: `corrupted double-linked list`

## \_int\_malloc

This function is responsible for allocating memory from the heap. Checks here ensure memory is not corrupted during allocation.

* **Fastbin Size Check**:
  * When removing a chunk from a fastbin, ensure the chunk's size is within the fastbin range.
    * Error message: `malloc(): memory corruption (fast)`
* **Smallbin Consistency Check**:
  * When removing a chunk from a smallbin, ensure the previous and next links in the doubly linked list are consistent.
    * Error message: `malloc(): smallbin double linked list corrupted`
* **Unsorted Bin Memory Range Check**:
  * Ensure the size of chunks in the unsorted bin is within minimum and maximum limits.
    * Error message: `malloc(): memory corruption`
* **Unsorted Bin Consistency Check (First Scenario)**:
  * When inserting a remainder chunk into the unsorted bin, check if `unsorted_chunks(av)->fd->bk == unsorted_chunks(av)`.
    * Error message: `malloc(): corrupted unsorted chunks`
* **Unsorted Bin Consistency Check (Second Scenario)**:
  * Same as the previous check, but triggered when inserting after splitting a fast or small chunk.
    * Error message: `malloc(): corrupted unsorted chunks 2`

## \_int\_free

This function frees previously allocated memory. The checks here help ensure proper memory deallocation and prevent memory corruption.

* **Pointer Boundary Check**:
  * Ensure the pointer being freed isn't wrapping around the memory.
    * Error message: `free(): invalid pointer`
* **Size Check**:
  * Ensure the size of the chunk being freed is at least `MINSIZE` or a multiple of `MALLOC_ALIGNMENT`.
    * Error message: `free(): invalid size`
* **Fastbin Size Check**:
  * For fastbin chunks, ensure the next chunk's size is within the minimum and maximum limits.
    * Error message: `free(): invalid next size (fast)`
* **Fastbin Double Free Check**:
  * When inserting a chunk into a fastbin, ensure the chunk at the head isn't the same as the one being inserted.
    * Error message: `double free or corruption (fasttop)`
* **Fastbin Consistency Check**:
  * When inserting into a fastbin, ensure the sizes of the head chunk and the chunk being inserted are the same.
    * Error message: `invalid fastbin entry (free)`
* **Top Chunk Consistency Check**:
  * For non-fastbin chunks, ensure the chunk isn't the same as the top chunk.
    * Error message: `double free or corruption (top)`
* **Memory Boundaries Check**:
  * Ensure the next chunk by memory is within the boundaries of the arena.
    * Error message: `double free or corruption (out)`
* **Prev\_inuse Bit Check**:
  * Ensure the previous-in-use bit in the next chunk is marked.
    * Error message: `double free or corruption (!prev)`
* **Normal Size Check**:
  * Ensure the size of the next chunk is within valid ranges.
    * Error message: `free(): invalid next size (normal)`
* **Unsorted Bin Consistency Check**:
  * When inserting a coalesced chunk into the unsorted bin, check if `unsorted_chunks(av)->fd->bk == unsorted_chunks(av)`.
    * Error message: `free(): corrupted unsorted chunks`

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
